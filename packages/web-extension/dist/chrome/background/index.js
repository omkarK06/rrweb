(function(y){typeof define=="function"&&define.amd?define(y):y()})(function(){"use strict";var Y=Object.defineProperty;var ee=(y,v,o)=>v in y?Y(y,v,{enumerable:!0,configurable:!0,writable:!0,value:o}):y[v]=o;var $=(y,v,o)=>(ee(y,typeof v!="symbol"?v+"":v,o),o);var y=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},v={exports:{}};(function(n,a){(function(s,r){r(n)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:y,function(s){var r,m;if(!((m=(r=globalThis.chrome)==null?void 0:r.runtime)!=null&&m.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const c="The message port closed before a response was received.",u=x=>{const b={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(b).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class T extends WeakMap{constructor(t,g=void 0){super(g),this.createItem=t}get(t){return this.has(t)||this.set(t,this.createItem(t)),super.get(t)}}const B=e=>e&&typeof e=="object"&&typeof e.then=="function",q=(e,t)=>(...g)=>{x.runtime.lastError?e.reject(new Error(x.runtime.lastError.message)):t.singleCallbackArg||g.length<=1&&t.singleCallbackArg!==!1?e.resolve(g[0]):e.resolve(g)},P=e=>e==1?"argument":"arguments",V=(e,t)=>function(A,...f){if(f.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${P(t.minArgs)} for ${e}(), got ${f.length}`);if(f.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${P(t.maxArgs)} for ${e}(), got ${f.length}`);return new Promise((h,p)=>{if(t.fallbackToNoCallback)try{A[e](...f,q({resolve:h,reject:p},t))}catch(i){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),A[e](...f),t.fallbackToNoCallback=!1,t.noCallback=!0,h()}else t.noCallback?(A[e](...f),h()):A[e](...f,q({resolve:h,reject:p},t))})},U=(e,t,g)=>new Proxy(t,{apply(A,f,h){return g.call(f,e,...h)}});let R=Function.call.bind(Object.prototype.hasOwnProperty);const M=(e,t={},g={})=>{let A=Object.create(null),f={has(p,i){return i in e||i in A},get(p,i,w){if(i in A)return A[i];if(!(i in e))return;let d=e[i];if(typeof d=="function")if(typeof t[i]=="function")d=U(e,e[i],t[i]);else if(R(g,i)){let S=V(i,g[i]);d=U(e,e[i],S)}else d=d.bind(e);else if(typeof d=="object"&&d!==null&&(R(t,i)||R(g,i)))d=M(d,t[i],g[i]);else if(R(g,"*"))d=M(d,t[i],g["*"]);else return Object.defineProperty(A,i,{configurable:!0,enumerable:!0,get(){return e[i]},set(S){e[i]=S}}),d;return A[i]=d,d},set(p,i,w,d){return i in A?A[i]=w:e[i]=w,!0},defineProperty(p,i,w){return Reflect.defineProperty(A,i,w)},deleteProperty(p,i){return Reflect.deleteProperty(A,i)}},h=Object.create(e);return new Proxy(h,f)},N=e=>({addListener(t,g,...A){t.addListener(e.get(g),...A)},hasListener(t,g){return t.hasListener(e.get(g))},removeListener(t,g){t.removeListener(e.get(g))}}),K=new T(e=>typeof e!="function"?e:function(g){const A=M(g,{},{getContent:{minArgs:0,maxArgs:0}});e(A)}),W=new T(e=>typeof e!="function"?e:function(g,A,f){let h=!1,p,i=new Promise(E=>{p=function(k){h=!0,E(k)}}),w;try{w=e(g,A,p)}catch(E){w=Promise.reject(E)}const d=w!==!0&&B(w);if(w!==!0&&!d&&!h)return!1;const S=E=>{E.then(k=>{f(k)},k=>{let j;k&&(k instanceof Error||typeof k.message=="string")?j=k.message:j="An unexpected error occurred",f({__mozWebExtensionPolyfillReject__:!0,message:j})}).catch(k=>{console.error("Failed to send onMessage rejected reply",k)})};return S(d?w:i),!0}),Q=({reject:e,resolve:t},g)=>{x.runtime.lastError?x.runtime.lastError.message===c?t():e(new Error(x.runtime.lastError.message)):g&&g.__mozWebExtensionPolyfillReject__?e(new Error(g.message)):t(g)},G=(e,t,g,...A)=>{if(A.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${P(t.minArgs)} for ${e}(), got ${A.length}`);if(A.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${P(t.maxArgs)} for ${e}(), got ${A.length}`);return new Promise((f,h)=>{const p=Q.bind(null,{resolve:f,reject:h});A.push(p),g.sendMessage(...A)})},X={devtools:{network:{onRequestFinished:N(K)}},runtime:{onMessage:N(W),onMessageExternal:N(W),sendMessage:G.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:G.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},L={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return b.privacy={network:{"*":L},services:{"*":L},websites:{"*":L}},M(x,X,b)};s.exports=u(chrome)}else s.exports=globalThis.browser})})(v);const o=v.exports;function J(n){return{all:n=n||new Map,on:function(a,s){var r=n.get(a);r?r.push(s):n.set(a,[s])},off:function(a,s){var r=n.get(a);r&&(s?r.splice(r.indexOf(s)>>>0,1):n.set(a,[]))},emit:function(a,s){var r=n.get(a);r&&r.slice().map(function(m){m(s)}),(r=n.get("*"))&&r.slice().map(function(m){m(a,s)})}}}class H{constructor(){$(this,"services",new Map);$(this,"emitter",J());o.runtime.onMessage.addListener(((a,s)=>{const r=JSON.parse(a);if(!r||!r.type){console.error(`Bad message: ${a}`);return}switch(r.type){case"event":this.emitter.emit(r.event,{detail:r.detail,sender:s});break;case"service":{const m=this.services.get(r.service);if(!m)break;return m(r.params,s)}default:console.error(`Unknown message type: ${r.type}`);break}}).bind(this))}provide(a,s){return this.services.set(a,s),()=>{this.services.delete(a)}}request(a,s){const r=JSON.stringify({type:"service",service:a,params:s});return o.runtime.sendMessage(r)}requestToTab(a,s,r){if(!o.tabs||!o.tabs.sendMessage)return Promise.reject("Can not send message to tabs in current context!");const m=JSON.stringify({type:"service",service:s,params:r});return o.tabs.sendMessage(a,m)}on(a,s){const r=m=>{s(m.detail,m.sender)};return this.emitter.on(a,r)}emit(a,s){const r=JSON.stringify({type:"event",event:a,detail:s});o.runtime.sendMessage(r)}emitToTabs(a,s,r){if(!o.tabs||!o.tabs.sendMessage)return Promise.reject("Can not send message to tabs in current context!");typeof a=="number"&&(a=[a]);const m=JSON.stringify({type:"event",event:s,detail:r});a.forEach(c=>void o.tabs.sendMessage(c,m))}async getCurrentTabId(){return(await o.tabs.query({active:!0,currentWindow:!0}))[0].id||-1}}var F=(n=>(n.settings="settings",n))(F||{}),l=(n=>(n.recorderStatus="recorder_status",n.bufferedEvents="buffered_events",n))(l||{}),C=(n=>(n.IDLE="IDLE",n.RECORDING="RECORDING",n.PAUSED="PAUSED",n.PausedSwitch="PAUSED_SWITCH",n))(C||{}),O=(n=>(n.StartRecord="start-record",n.StopRecord="stop-record",n.PauseRecord="pause-record",n.ResumeRecord="resume-record",n))(O||{});function Z(){return window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1}async function z(n,a,s){s||(s=(await o.storage.local.get(l.recorderStatus))[l.recorderStatus]);const{startTimestamp:r,activeTabId:m}=s,c=await n.requestToTab(m,O.PauseRecord,{});if(!c)return;const u={status:a,activeTabId:m,startTimestamp:r,pausedTimestamp:c.endTimestamp};return await o.storage.local.set({[l.recorderStatus]:u}),{status:u,bufferedEvents:c.events}}async function _(n,a,s,r){s||(s=(await o.storage.local.get(l.recorderStatus))[l.recorderStatus]),r||(r=(await o.storage.local.get(l.bufferedEvents))[l.bufferedEvents]);const{startTimestamp:m,pausedTimestamp:c}=s;Z()&&await new Promise(T=>setTimeout(T,50));const u=await n.requestToTab(a,O.ResumeRecord,{events:r,pausedTimestamp:c});if(!u)return;const x=c?u.startTimestamp-c:0,b={status:C.RECORDING,activeTabId:a,startTimestamp:(m||r[0].timestamp)+x};return await o.storage.local.set({[l.recorderStatus]:b}),b}const D=new H;(async()=>{const n=await o.storage.sync.get(F.settings)||void 0,a={};let s=a;n&&n.settings&&(I(n.settings,a),s=n.settings),await o.storage.sync.set({settings:s}),o.tabs.onActivated.addListener(r=>{o.storage.local.get(l.recorderStatus).then(async m=>{const c=m;if(!c||!c[l.recorderStatus])return;let u=c[l.recorderStatus],{status:x}=u,b;if(x===C.RECORDING){const T=await z(D,C.PausedSwitch,u).catch(async()=>({status:(await o.storage.local.get(l.recorderStatus))[l.recorderStatus],bufferedEvents:b}));if(!T)return;u=T.status,x=u.status,b=T.bufferedEvents}x===C.PausedSwitch&&await _(D,r.tabId,u,b)}).catch(()=>{})}),o.tabs.onUpdated.addListener(function(r,m){m.status==="complete"&&o.storage.local.get(l.recorderStatus).then(async c=>{const u=c;if(!u||!u[l.recorderStatus])return;const{status:x,activeTabId:b}=u[l.recorderStatus];x!==C.PausedSwitch||b===r||await _(D,r,u[l.recorderStatus])}).catch(()=>{})}),o.tabs.onRemoved.addListener(r=>{o.storage.local.get(l.recorderStatus).then(async m=>{const c=m;if(!c||!c[l.recorderStatus])return;const{status:u,activeTabId:x,startTimestamp:b}=c[l.recorderStatus];if(x!==r||u!==C.RECORDING)return;const T={status:C.PausedSwitch,activeTabId:x,startTimestamp:b,pausedTimestamp:Date.now()};await o.storage.local.set({[l.recorderStatus]:T})}).catch(m=>{console.error(m)})})})();function I(n,a){for(const s in a)typeof a[s]=="object"&&!(a[s]instanceof Array)&&Object.keys(a[s]).length>0?n[s]?I(n[s],a[s]):n[s]=a[s]:n[s]===void 0&&(n[s]=a[s])}});
