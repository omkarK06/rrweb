var C=Object.defineProperty;var L=(e,t,n)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var y=(e,t,n)=>(L(e,typeof t!="symbol"?t+"":t,n),n);import{b as c}from"./browser-polyfill.js";function O(e){return{all:e=e||new Map,on:function(t,n){var s=e.get(t);s?s.push(n):e.set(t,[n])},off:function(t,n){var s=e.get(t);s&&(n?s.splice(s.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var s=e.get(t);s&&s.slice().map(function(r){r(n)}),(s=e.get("*"))&&s.slice().map(function(r){r(t,n)})}}}class q{constructor(){y(this,"services",new Map);y(this,"emitter",O());c.runtime.onMessage.addListener(((t,n)=>{const s=JSON.parse(t);if(!s||!s.type){console.error(`Bad message: ${t}`);return}switch(s.type){case"event":this.emitter.emit(s.event,{detail:s.detail,sender:n});break;case"service":{const r=this.services.get(s.service);if(!r)break;return r(s.params,n)}default:console.error(`Unknown message type: ${s.type}`);break}}).bind(this))}provide(t,n){return this.services.set(t,n),()=>{this.services.delete(t)}}request(t,n){const s=JSON.stringify({type:"service",service:t,params:n});return c.runtime.sendMessage(s)}requestToTab(t,n,s){if(!c.tabs||!c.tabs.sendMessage)return Promise.reject("Can not send message to tabs in current context!");const r=JSON.stringify({type:"service",service:n,params:s});return c.tabs.sendMessage(t,r)}on(t,n){const s=r=>{n(r.detail,r.sender)};return this.emitter.on(t,s)}emit(t,n){const s=JSON.stringify({type:"event",event:t,detail:n});c.runtime.sendMessage(s)}emitToTabs(t,n,s){if(!c.tabs||!c.tabs.sendMessage)return Promise.reject("Can not send message to tabs in current context!");typeof t=="number"&&(t=[t]);const r=JSON.stringify({type:"event",event:n,detail:s});t.forEach(i=>void c.tabs.sendMessage(i,r))}async getCurrentTabId(){return(await c.tabs.query({active:!0,currentWindow:!0}))[0].id||-1}}var j=(e=>(e.recorderStatus="recorder_status",e.bufferedEvents="buffered_events",e))(j||{}),A=(e=>(e.IDLE="IDLE",e.RECORDING="RECORDING",e.PAUSED="PAUSED",e.PausedSwitch="PAUSED_SWITCH",e))(A||{}),k=(e=>(e.StartRecord="start-record",e.StopRecord="stop-record",e.PauseRecord="pause-record",e.ResumeRecord="resume-record",e))(k||{}),R=(e=>(e.SessionUpdated="session-updated",e))(R||{});const x=(e,t)=>t.some(n=>e instanceof n);let E,I;function N(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return I||(I=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const B=new WeakMap,w=new WeakMap,P=new WeakMap,g=new WeakMap,S=new WeakMap;function W(e){const t=new Promise((n,s)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{n(u(e.result)),r()},o=()=>{s(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",o)});return t.then(n=>{n instanceof IDBCursor&&B.set(n,e)}).catch(()=>{}),S.set(t,e),t}function J(e){if(w.has(e))return;const t=new Promise((n,s)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{n(),r()},o=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});w.set(e,t)}let v={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return w.get(e);if(t==="objectStoreNames")return e.objectStoreNames||P.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return u(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function U(e){v=e(v)}function F(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const s=e.call(h(this),t,...n);return P.set(s,t.sort?t.sort():[t]),u(s)}:V().includes(e)?function(...t){return e.apply(h(this),t),u(B.get(this))}:function(...t){return u(e.apply(h(this),t))}}function _(e){return typeof e=="function"?F(e):(e instanceof IDBTransaction&&J(e),x(e,N())?new Proxy(e,v):e)}function u(e){if(e instanceof IDBRequest)return W(e);if(g.has(e))return g.get(e);const t=_(e);return t!==e&&(g.set(e,t),S.set(t,e)),t}const h=e=>S.get(e);function T(e,t,{blocked:n,upgrade:s,blocking:r,terminated:i}={}){const o=indexedDB.open(e,t),m=u(o);return s&&o.addEventListener("upgradeneeded",a=>{s(u(o.result),a.oldVersion,a.newVersion,u(o.transaction),a)}),n&&o.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),m.then(a=>{i&&a.addEventListener("close",()=>i()),r&&a.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),m}const $=["get","getKey","getAll","getAllKeys","count"],G=["put","add","delete","clear"],b=new Map;function M(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(b.get(t))return b.get(t);const n=t.replace(/FromIndex$/,""),s=t!==n,r=G.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(r||$.includes(n)))return;const i=async function(o,...m){const a=this.transaction(o,r?"readwrite":"readonly");let d=a.store;return s&&(d=d.index(m.shift())),(await Promise.all([d[n](...m),r&&a.done]))[0]};return b.set(t,i),i}U(e=>({...e,get:(t,n,s)=>M(t,n)||e.get(t,n,s),has:(t,n)=>!!M(t,n)||e.has(t,n)}));const p="events";async function D(){return T(p,1,{upgrade(e){e.createObjectStore(p,{keyPath:"id",autoIncrement:!1})}})}async function z(e){return(await(await D()).get(p,e)).events}const f="sessions";async function l(){return T(f,1,{upgrade(e){e.createObjectStore(f,{keyPath:"id",autoIncrement:!1})}})}async function Q(e,t){await(await D()).put(p,{id:e.id,events:t}),await(await l()).add(f,e)}async function X(e){return(await l()).get(f,e)}async function Y(){return(await(await l()).getAll(f)).sort((n,s)=>s.createTimestamp-n.createTimestamp)}async function Z(e){const t=await D(),n=await l(),s=t.transaction(p,"readwrite"),r=n.transaction(f,"readwrite"),i=[];for(const o of e)i.push(s.store.delete(o)),i.push(r.store.delete(o));await Promise.all(i).then(()=>Promise.all([s.done,r.done]))}export{q as C,R as E,j as L,A as R,k as S,X as a,z as b,Z as d,Y as g,Q as s};
